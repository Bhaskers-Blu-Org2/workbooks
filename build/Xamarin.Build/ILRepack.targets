<Project>
  <Target
    Name="ILRepack"
    AfterTargets="Build"
    Condition="!$([MSBuild]::IsOsPlatform('Linux'))"
    Inputs="$(UnpackedAssembly)"
    Outputs="$(PackedAssembly)">
    <ItemGroup>
      <NuGetSearchPaths Include="$(NuGetPackageFolders)" />
    </ItemGroup>
    <ItemGroup Condition="$([MSBuild]::ISOSUnixLike())">
      <NetstandardLibraryPaths Include="$([MSBuild]::NormalizeDirectory(%(NuGetSearchPaths.Identity)))netstandard.library\**\netstandard.dll" />
    </ItemGroup>
    <PropertyGroup>
      <CILRunner Condition='$([MSBuild]::IsOSUnixLike())'>mono </CILRunner>
    </PropertyGroup>
    <ItemGroup>
      <ReferencedAssembly Include="$(OutputPath)*.dll" Exclude="$(OutputPath)System.*;$(OutputPath)Microsoft.*;$(UnpackedAssembly)" />
    </ItemGroup>
    <Exec Command="$(CILRunner)$(ILRepack) /internalize $(UnpackedAssembly) @(ReferencedAssembly -> '%(Identity)', ' ') /out:$(PackedAssembly) /lib:$(OutputPath) @(NetstandardLibraryPaths -> '/lib:%(RootDir)%(Directory)', ' ')" />
    <Exec Condition="$([MSBuild]::IsOSUnixLike())" Command="chmod +x $(PackedAssembly)" />
  </Target>
</Project>